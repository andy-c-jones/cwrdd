# Database Schema

This directory contains the database schema for cwrdd.

## Structure

- `schema/` - Declarative SQL schema files (CREATE TABLE statements)
- `migrations/` - Generated Liquibase changesets (created by diffChangeLog)
- `scripts/` - SQL scripts for database operations
- `liquibase.properties` - Liquibase configuration

## Liquibase with diffChangeLog

We use **Liquibase Community Edition with diffChangeLog** for schema management:

### Declarative Schema Approach

1. **Declare schema** - Write `CREATE TABLE` statements in `schema/` directory
2. **Generate diff** - Run `diffChangeLog` to compare schema files with database
3. **Apply changes** - Liquibase generates and applies the necessary changesets
4. **Version control** - Generated changesets are committed for audit trail

### Workflow

```bash
# 1. Edit schema files in schema/ directory
vim db/schema/users.sql

# 2. Generate migration from diff
cwrdd-make migrate-diff

# 3. Review generated changeset in migrations/
cat db/migrations/YYYYMMDD-HHMMSS-changes.xml

# 4. Apply migration
cwrdd-make migrate

# 5. Commit both schema and generated migration
git add db/schema/ db/migrations/
git commit -m "Add users table"
```

### Benefits

- **Declarative**: Schema files are the source of truth
- **Automatic**: Liquibase generates the diff automatically
- **Safe**: Review generated changesets before applying
- **Auditable**: All changes tracked in version control
- **Rollback**: Liquibase can generate rollback from diff

## Running Migrations

Using cwrdd-make:

```bash
# Generate diff changeset from schema files
cwrdd-make migrate-diff

# Apply all pending migrations
cwrdd-make migrate

# Show migration status
cwrdd-make migrate-status

# Rollback last changeset
cwrdd-make rollback
```

## Schema Files

Schema files are pure SQL `CREATE TABLE` statements:

- `schema/users.sql` - Users table definition
- (More tables to be added)

These files represent the **desired state** of the database. Liquibase will generate the necessary changes to reach this state.

## Generated Migrations

The `migrations/` directory contains Liquibase changesets generated by `diffChangeLog`:

- Automatically created by comparing schema files to database
- Should be committed to version control
- Provide audit trail of all schema changes
- Include timestamps for ordering

## Database Configuration

Default configuration for local development in `liquibase.properties`:

- Database: `cwrdd_dev`
- User: `cwrdd_user`
- Host: `localhost:5432`

Override with environment-specific properties for other environments.

## Initial Setup

For a new database:

1. Start PostgreSQL (via docker-compose or local)
2. Run `cwrdd-make migrate-diff` to generate initial schema
3. Run `cwrdd-make migrate` to apply
4. Optionally run `cwrdd-make seed` for development data

